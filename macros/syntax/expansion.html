<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js ayu">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Expansion - The Little Book of Rust Macros</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../../favicon.svg">
        
        
        <link rel="shortcut icon" href="../../favicon.png">
        
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
        <link rel="stylesheet" href="../../res/code-font-patch.css">
        
        <link rel="stylesheet" href="../../res/rust-syntax-bg-highlight.css">
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="../../macros.html"><strong aria-hidden="true">1.</strong> Macros, A Methodical Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../macros/syntax.html"><strong aria-hidden="true">1.1.</strong> Syntax Extensions</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../macros/syntax/source-analysys.html"><strong aria-hidden="true">1.1.1.</strong> Source Analysis</a></li><li class="chapter-item expanded "><a href="../../macros/syntax/ast.html"><strong aria-hidden="true">1.1.2.</strong> Macros in the Ast</a></li><li class="chapter-item expanded "><a href="../../macros/syntax/expansion.html" class="active"><strong aria-hidden="true">1.1.3.</strong> Expansion</a></li></ol></li><li class="chapter-item expanded "><a href="../../macros/macro_rules.html"><strong aria-hidden="true">1.2.</strong> macro_rules!</a></li><li class="chapter-item expanded "><a href="../../macros/minutiae.html"><strong aria-hidden="true">1.3.</strong> Minutiae</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../macros/minutiae/metavar-and-expansion.html"><strong aria-hidden="true">1.3.1.</strong> Metavariables and Expansion Redux</a></li><li class="chapter-item expanded "><a href="../../macros/minutiae/hygiene.html"><strong aria-hidden="true">1.3.2.</strong> Hygiene</a></li><li class="chapter-item expanded "><a href="../../macros/minutiae/identifiers.html"><strong aria-hidden="true">1.3.3.</strong> Non-Identifier Identifiers</a></li><li class="chapter-item expanded "><a href="../../macros/minutiae/debugging.html"><strong aria-hidden="true">1.3.4.</strong> Debugging</a></li><li class="chapter-item expanded "><a href="../../macros/minutiae/scoping.html"><strong aria-hidden="true">1.3.5.</strong> Scoping</a></li><li class="chapter-item expanded "><a href="../../macros/minutiae/import-export.html"><strong aria-hidden="true">1.3.6.</strong> Import and Export</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../macros-practical.html"><strong aria-hidden="true">2.</strong> Macros, A Practical Introduction</a></li><li class="chapter-item expanded "><a href="../../patterns.html"><strong aria-hidden="true">3.</strong> Patterns</a></li><li class="chapter-item expanded "><a href="../../building-blocks.html"><strong aria-hidden="true">4.</strong> Building Blocks</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../building-blocks/ast-coercion.html"><strong aria-hidden="true">4.1.</strong> AST Coercion</a></li><li class="chapter-item expanded "><a href="../../building-blocks/counting.html"><strong aria-hidden="true">4.2.</strong> Counting</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu (default)</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">The Little Book of Rust Macros</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        <a href="https://github.com/veykril/tlborm/" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#expansion" id="expansion">Expansion</a></h1>
<p>Expansion is a relatively simple affair. At some point <em>after</em> the construction of the AST, but
before the compiler begins constructing its semantic understanding of the program, it will expand
all macros.</p>
<p>This involves traversing the AST, locating macro invocations and replacing them with their
expansion. In the case of non-macro syntax extensions, <em>how</em> this happens is up to the particular
syntax extension. That said, syntax extensions go through <em>exactly</em> the same process that macros do
once their expansion is complete.</p>
<p>Once the compiler has run a syntax extension, it expects the result to be parseable as one of a
limited set of syntax elements, based on context. For example, if you invoke a macro at module scope,
the compiler will parse the result into an AST node that represents an item. If you invoke a macro
in expression position, the compiler will parse the result into an expression AST node.</p>
<p>In fact, it can turn a syntax extension result into any of the following:</p>
<ul>
<li>an expression,</li>
<li>a pattern,</li>
<li>a type,</li>
<li>zero or more items, or</li>
<li>zero or more statements.</li>
</ul>
<p>In other words, <em>where</em> you can invoke a macro determines what its result will be interpreted as.</p>
<p>The compiler will take this AST node and completely replace the macro's invocation node with the
output node. <em>This is a structural operation</em>, not a textural one!</p>
<p>For example, consider the following:</p>
<pre><code class="language-rust ignore">let eight = 2 * four!();
</code></pre>
<p>We can visualise this partial AST as follows:</p>
<pre><code class="language-text">┌─────────────┐
│ Let         │
│ name: eight │   ┌─────────┐
│ init: ◌     │╶─╴│ BinOp   │
└─────────────┘   │ op: Mul │
                ┌╴│ lhs: ◌  │
     ┌────────┐ │ │ rhs: ◌  │╶┐ ┌────────────┐
     │ LitInt │╶┘ └─────────┘ └╴│ Macro      │
     │ val: 2 │                 │ name: four │
     └────────┘                 │ body: ()   │
                                └────────────┘
</code></pre>
<p>From context, <code>four!()</code> <em>must</em> expand to an expression (the initializer can <em>only</em> be an expression).
Thus, whatever the actual expansion is, it will be interpreted as a complete expression. In this
case, we will assume <code>four!</code> is defined such that it expands to the expression <code>1 + 3</code>.  As a result,
expanding this invocation will result in the AST changing to:</p>
<pre><code class="language-text">┌─────────────┐
│ Let         │
│ name: eight │   ┌─────────┐
│ init: ◌     │╶─╴│ BinOp   │
└─────────────┘   │ op: Mul │
                ┌╴│ lhs: ◌  │
     ┌────────┐ │ │ rhs: ◌  │╶┐ ┌─────────┐
     │ LitInt │╶┘ └─────────┘ └╴│ BinOp   │
     │ val: 2 │                 │ op: Add │
     └────────┘               ┌╴│ lhs: ◌  │
                   ┌────────┐ │ │ rhs: ◌  │╶┐ ┌────────┐
                   │ LitInt │╶┘ └─────────┘ └╴│ LitInt │
                   │ val: 1 │                 │ val: 3 │
                   └────────┘                 └────────┘
</code></pre>
<p>This can be written out like so:</p>
<pre><code class="language-rust ignore">let eight = 2 * (1 + 3);
</code></pre>
<p>Note that we added parens <em>despite</em> them not being in the expansion.  Remember that the compiler
always treats the expansion of a macro as a complete AST node, <strong>not</strong> as a mere sequence of tokens.
To put it another way, even if you don't explicitly wrap a complex expression in parentheses, there
is no way for the compiler to &quot;misinterpret&quot; the result, or change the order of evaluation.</p>
<p>It is important to understand that macro expansions are treated as AST nodes, as this design has two
further implications:</p>
<ul>
<li>In addition to there being a limited number of invocation <em>positions</em>, macros can <em>only</em> expand to
the kind of AST node the parser <em>expects</em> at that position.</li>
<li>As a consequence of the above, macros <em>absolutely cannot</em> expand to incomplete or syntactically
invalid constructs.</li>
</ul>
<p>There is one further thing to note about expansion: what happens when a syntax extension expands to
something that contains <em>another</em> syntax extension invocation. For example, consider an alternative
definition of <code>four!</code>; what happens if it expands to <code>1 + three!()</code>?</p>
<pre><code class="language-rust ignore">let x = four!();
</code></pre>
<p>Expands to:</p>
<pre><code class="language-rust ignore">let x = 1 + three!();
</code></pre>
<p>This is resolved by the compiler checking the result of expansions for additional macro invocations,
and expanding them. Thus, a second expansion step turns the above into:</p>
<pre><code class="language-rust ignore">let x = 1 + 3;
</code></pre>
<p>The takeaway here is that expansion happens in &quot;passes&quot;; as many as is needed to completely expand
all invocations.</p>
<p>Well, not <em>quite</em>. In fact, the compiler imposes an upper limit on the number of such recursive
passes it is willing to run before giving up. This is known as the macro recursion limit and
defaults to 32. If the 32nd expansion contains a macro invocation, the compiler will abort with an
error indicating that the recursion limit was exceeded.</p>
<p>This limit can be raised using the <code>#![recursion_limit=&quot;…&quot;]</code> <a href="https://doc.rust-lang.org/reference/attributes/limits.html#the-recursion_limit-attribute">attribute</a>, though it <em>must</em> be done
crate-wide. Generally, it is recommended to try and keep macros below this limit wherever possible
as it may impact compilation times.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../macros/syntax/ast.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../macros/macro_rules.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../macros/syntax/ast.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../macros/macro_rules.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
